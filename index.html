<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KeraNova Hair – TypeTeller</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#fff; --text:#111; --brand:#1f6feb; --muted:#f4f6f8; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
    header { display:flex; align-items:center; gap:12px; margin-bottom: 16px; flex-wrap:wrap; }
    header img { height: 32px; }
    h1 { margin: 0; font-size: 20px; width: 100%; }
    .card { background: var(--muted); border-radius: 12px; padding: 16px; position: relative; }
    .row { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:960px){ .row{ grid-template-columns: 1.1fr 1fr; } }
    button { background:var(--brand); color:#fff; border:0; padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer; }
    button[disabled]{ opacity:.5; cursor:not-allowed; }
    .muted { color:#555; font-size:14px; }
    .result { font-size:22px; font-weight:700; margin: 8px 0 4px; }
    .desc { font-size:14px; }
    .hidden { display:none; }
    .divider { height:1px; background:#e6e9ec; margin:16px 0; }
    .consent { display:flex; gap:12px; align-items:flex-start; margin:8px 0; }
    
    /* Enhanced Typeform container responsiveness */
    #tf-form { 
      width: 100%; 
      min-height: 600px; 
    }
    @media(min-width:960px) {
      #tf-form { 
        min-height: 720px; 
      }
    }
    
    /* Improved close button accessibility */
    .close-btn { 
      position: absolute; 
      top: 8px; 
      right: 12px; 
      background: transparent; 
      border: none; 
      font-size: 20px; 
      cursor: pointer; 
      color: #555;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .close-btn:hover, .close-btn:focus { 
      color: #000; 
      background: rgba(0,0,0,0.1);
      outline: 2px solid var(--brand);
    }
    
    /* Open form button styling */
    .open-form-btn {
      background: var(--brand);
      color: #fff;
      border: 0;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    .open-form-btn:hover, .open-form-btn:focus {
      background: #1a5cd8;
      outline: 2px solid #0969da;
    }
    
    /* Error message styling */
    .error-message {
      color: #d1242f;
      background: #fff8f8;
      border: 1px solid #ffdddd;
      padding: 8px 12px;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 14px;
    }
  </style>
  <script src="https://embed.typeform.com/next/embed.js" defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="https://dummyimage.com/160x40/000/fff&text=KeraNova" alt="KeraNova">
      <h1>Hair Type Teller</h1>
    </header>

    <p class="muted">Upload a clear hair photo. We'll show the top hair type and confidence, then you can leave your email.</p>

    <div class="row">
      <div class="card">
        <label><strong>1) Upload photo (JPEG/PNG)</strong></label><br/>
        <input id="file" type="file" accept="image/jpeg,image/png" />

        <div class="divider"></div>
        <strong>2) Consent</strong>
        <div class="consent">
          <input id="c13" type="checkbox">
          <label for="c13">I am 13+ and agree to process my photo for a one-time prediction. Photos are <em>not</em> stored unless I opt in.</label>
        </div>
        <div class="consent">
          <input id="cstore" type="checkbox">
          <label for="cstore">I consent to let KeraNova store this photo to improve the model (optional).</label>
        </div>
        <a href="#" target="_blank" class="muted">Privacy Policy</a>

        <div style="margin-top:12px;">
          <button id="analyze" disabled>Analyze</button>
          <span id="status" class="muted" style="margin-left:8px;"></span>
        </div>

        <div id="out" class="hidden" style="margin-top:16px;">
          <div class="result" id="labelText">—</div>
          <div class="desc" id="descText">—</div>
        </div>
      </div>

      <div class="card" id="typeform-card">
        <!-- Enhanced close button with accessibility -->
        <button class="close-btn" id="closeTypeform" aria-label="Close email form" role="button">&times;</button>
        <label><strong>Leave your email (optional)</strong></label>
        <div id="tf-form" role="region" aria-label="Email signup form"></div>
        <!-- Open form button (initially hidden) -->
        <button class="open-form-btn hidden" id="openTypeform" aria-label="Open email form">Open Form</button>
      </div>
    </div>
  </div>

<script type="module">
  import { client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

  const SPACE_ID = "daniblack1/Hair-Trainer-2025";
  const TYPEFORM_ID = "01K4T4CR7PWM5WCCH8KKPW1K5F";
  const DESCRIPTIONS = {
    "Type 1: Straight": "Smooth strands with minimal bend; can look shiny and may resist curls. Use lightweight wash/conditioner and a weightless volumizer.",
    "Type 2: Wavy":     "Loose S-shaped pattern; can frizz or fall flat if products are heavy. Use light mousse or texturizing spray.",
    "Type 3: Curly":    "Defined, springy curls and volume; frizz-prone. Use moisture-rich wash, curl cream + gel; leave-in helps.",
    "Type 4: Kinky":    "Tight coils/zig-zags; very delicate and dry by nature. Use rich creams/butters and oils; coil-defining styler."
  };

  const $ = (q)=>document.querySelector(q);
  const fileEl = $("#file"), analyzeBtn = $("#analyze"), statusEl = $("#status");
  const outBox = $("#out"), labelText = $("#labelText"), descText = $("#descText");
  const c13 = $("#c13"), cstore = $("#cstore");
  
  const typeformCard = $("#typeform-card");
  const closeBtn = $("#closeTypeform");
  const openBtn = $("#openTypeform");
  const tfContainer = $("#tf-form");

  let currentHiddenFields = {};
  let typeformVisible = true;
  let widgetCreationTimeout = null;

  function updateButton() {
    analyzeBtn.disabled = !(fileEl.files?.length && c13.checked);
  }
  fileEl.addEventListener("change", updateButton);
  c13.addEventListener("change", updateButton);

  const urlParams = new URLSearchParams(location.search);
  const UTM = {
    utm_source:  urlParams.get("utm_source")  || "",
    utm_medium:  urlParams.get("utm_medium")  || "",
    utm_campaign:urlParams.get("utm_campaign")|| ""
  };

  function renderTypeform(hairType="", confidence="", consent="") {
    // Clear any pending widget creation
    if (widgetCreationTimeout) {
      clearTimeout(widgetCreationTimeout);
    }
    
    // Update current hidden fields
    currentHiddenFields = { hairType, confidence, consent, ...UTM };
    
    // Only render if Typeform is visible
    if (!typeformVisible) return;
    
    widgetCreationTimeout = setTimeout(() => {
      const container = document.getElementById("tf-form");
      if (!container) return;
      
      container.innerHTML = "";
      
      // Guard window.tf access and retry if not available
      if (typeof window.tf !== 'undefined' && window.tf.createWidget) {
        try {
          window.tf.createWidget(TYPEFORM_ID, {
            container,
            hidden: currentHiddenFields,
            opacity: 100, 
            lazy: false
          });
        } catch (error) {
          console.warn("Typeform widget creation failed:", error);
        }
      } else {
        // Retry when Typeform library becomes available
        setTimeout(() => renderTypeform(hairType, confidence, consent), 500);
      }
    }, 100); // Debounce widget creation
  }

  function closeTypeform() {
    typeformVisible = false;
    tfContainer.style.display = "none";
    openBtn.classList.remove("hidden");
    // Focus management: move focus to open button
    setTimeout(() => openBtn.focus(), 100);
  }

  function openTypeform() {
    typeformVisible = true;
    tfContainer.style.display = "block";
    openBtn.classList.add("hidden");
    // Re-render with current hidden fields
    renderTypeform(currentHiddenFields.hairType, currentHiddenFields.confidence, currentHiddenFields.consent);
    // Focus management: move focus to Typeform container
    setTimeout(() => tfContainer.focus(), 200);
  }

  closeBtn.addEventListener("click", closeTypeform);
  closeBtn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      closeTypeform();
    }
  });

  openBtn.addEventListener("click", openTypeform);
  openBtn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") {
      e.preventDefault();
      openTypeform();
    }
  });

  let typeformInitialized = false;
  function initializeTypeform() {
    if (!typeformInitialized && typeformVisible) {
      typeformInitialized = true;
      renderTypeform();
    }
  }

  window.addEventListener("load", initializeTypeform);

  function showError(message) {
    // Remove any existing error messages
    const existingError = document.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }
    
    // Create and show new error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    statusEl.parentNode.insertBefore(errorDiv, statusEl.nextSibling);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (errorDiv.parentNode) {
        errorDiv.remove();
      }
    }, 5000);
  }

  analyzeBtn.addEventListener("click", async () => {
    try {
      // Clear any existing error messages
      const existingError = document.querySelector('.error-message');
      if (existingError) {
        existingError.remove();
      }
      
      statusEl.textContent = "Uploading…";
      const file = fileEl.files?.[0];
      if (!file) { 
        showError("Please select a JPEG or PNG file first.");
        statusEl.textContent = "";
        return; 
      }
      if (file.size > 8 * 1024 * 1024) { 
        showError("Please upload an image under 8 MB.");
        statusEl.textContent = "";
        return; 
      }

      const c = await client(SPACE_ID);
      statusEl.textContent = "Analyzing…";

      let res;
      try { res = await c.predict("/predict", [file]); }
      catch { res = await c.predict(0, [file]); }

      const out = res?.data?.[0];
      let label = "", conf = 0;

      if (out && typeof out === "object" && "label" in out && Array.isArray(out.confidences)) {
        label = out.label;
        const m = out.confidences.find(x => x.label === label);
        conf = m ? m.confidence : 0;
      } else if (out && typeof out === "object" && !Array.isArray(out)) {
        const entries = Object.entries(out).filter(([,v]) => typeof v === "number");
        if (!entries.length) throw new Error("Empty prediction dict");
        entries.sort((a,b)=>b[1]-a[1]);
        [label, conf] = [entries[0][0], entries[0][1]];
      } else if (Array.isArray(out) && out.length && Array.isArray(out[0])) {
        const entries = out.sort((a,b)=>b[1]-a[1]);
        [label, conf] = [entries[0][0], entries[0][1]];
      } else {
        throw new Error("Unexpected model output format");
      }

      const pct = Math.round(conf * 100);
      labelText.textContent = `${label} — ${pct}%`;
      descText.textContent  = DESCRIPTIONS[label] || "";
      outBox.classList.remove("hidden");
      statusEl.textContent = "Done.";

      const consent = cstore.checked ? "store_ok" : "no_store";
      initializeTypeform();
      renderTypeform(label, String(pct), consent);

    } catch (err) {
      console.error("Predict error:", err);
      statusEl.textContent = "";
      showError("Prediction failed. Please try another photo or check your internet connection.");
    }
  });
</script>

  <footer style="margin:24px 0; font-size:12px; color:#555;">
  <div>
    <strong>Privacy:</strong> Effective September 9, 2025 —
    <details style="margin-top:8px;">
      <summary style="cursor:pointer; color:#1f6feb; list-style: none; display:inline;">View policy</summary>
      <div style="margin-top:8px; max-height:280px; overflow:auto; border:1px solid #e6e9ec; padding:12px; border-radius:8px; background:#fafbfc;">
        <h4 style="margin:0 0 6px 0;">Privacy Policy — KeraNova Hair TypeTeller</h4>
        <p><strong>Effective date:</strong> September 9, 2025 &nbsp;|&nbsp; <strong>Last updated:</strong> September 9, 2025</p>
        <p><em>Summary:</em> We collect your uploaded photo, the model’s hair-type prediction and confidence, your consent choices (13+ / store photo), optional contact details, basic device/usage data, and UTM parameters. We do not sell personal information or share it for cross-context behavioral advertising. Photos are processed transiently and not stored unless you opt in; stored photos are kept until you request deletion.</p>
        <p><strong>Who we are:</strong> Keranova LLC (New York). We operate typeteller.keranovahair.com.</p>
        <p><strong>Use:</strong> Provide the prediction; improve the model only if you opt in to storage; communicate if requested; security and operations; legal compliance.</p>
        <p><strong>Sharing:</strong> Service providers – Vercel (site), Hugging Face (model/hosting; optional private dataset for consented photos), Typeform (optional form), Google Analytics 4 (usage metrics).</p>
        <p><strong>Retention:</strong> Photos not stored unless you opt in; if stored, kept until deletion request. Predictions/consents/usage logs retained as needed; contact data retained while we have a relationship or as required by law.</p>
        <p><strong>Your rights:</strong> You may have rights under CCPA/CPRA and GDPR (access/know, delete, correct, restrict, non-discrimination). Email <a href="mailto:privacy@keranovahair.com">privacy@keranovahair.com</a>.</p>
        <p><strong>Children:</strong> 13+ only.</p>
        <p><strong>Analytics:</strong> GA4 for pseudonymous usage metrics (no ads features).</p>
        <p><strong>Security:</strong> HTTPS, access controls, least-privilege tokens (no absolute security).</p>
        <p><strong>International transfers:</strong> Processing may occur in the U.S. and other countries with appropriate safeguards.</p>
        <p><strong>Changes:</strong> We will post updates with a new “Last updated.”</p>
        <p><strong>Contact:</strong> Keranova LLC, New York, NY · <a href="mailto:privacy@keranovahair.com">privacy@keranovahair.com</a></p>
      </div>
    </details>
  </div>
</footer>

</body>
</html>
